<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="/css/weui.css"/>
    <title>绑定学号 - 紫荆之声</title>
</head>
<body>
<div id="wrap">
    <header></header>

    <div class="theme" id="theme"></div>

    <hr/>
    <div id="mainbody"></div>

</div>
<footer id="footer">
    <hr />
    <a href="http://www.xuetangx.com/" target="_blank">学堂在线</a>
    <a href="http://www.tsinghua.edu.cn/" target="_blank">清华大学</a>
    <a href="https://github.com/ThssSE" target="_blank">软件工程</a><br>
    &copy; 2016
</footer>

<script type="text/template" id="tpl-header">
    <img class="header-img" src="/img/logo.jpg" />
</script>

<script type="text/template" id="tpl-theme">
    用户认证
</script>

<script type="text/template" id="tpl-mainbody">
    {% if isLoading %}
    <div id="successHolder">
        <img src="/img/loading.gif" />
    </div>
    {% else %}
    <form id="form-new-lost">

        <input type="text" name="itemName" id="itemName" value="" placeholder="物品名称"  autofocus />
        <span class="spa spa1"></span><br />

        <input type="text" name="itemDescription" id="itemDescription" value="" placeholder="物品描述" />
        <span class="spa spa2"></span><br />

        <input type="text" name="contactNumber" id="contactNumber" value="" placeholder="联系方式" />
        <span class="spa spa3"></span><br />

        <input type="text" name="contacts" id="contacts" value="" placeholder="联系人" />
        <span class="spa spa4"></span><br />

        <!-- 图片上传 -->
        <ul class="weui_uploader_files js_previews" id="uploaderFiles">
                <!-- 预览图插入到这 -->
        </ul>
        <div class="weui-uploader__input-box">
            <input id="uploadPic" class="weui-uploader__input" onclick="m_chooseImage()" multiple />
        </div>

        <button id="loginnow" type="submit" class="btn btn-block btn-primary">提交</button>
    </form>

    <div class="weui-gallery" id="gallery">
        <span class="weui-gallery__img" id="galleryImg" onclick="m_backFromPreview()"></span>
        <div class="weui-gallery__opr">
            <a href="javascript:" class="weui-gallery__del">
                <i class="weui-icon-delete weui-icon_gallery-delete" onclick="m_deleteImage()"></i>
            </a>
        </div>
    </div>
</div>

    {% endif %}
</script>

<script src="/3rd/jquery.js"></script>
<script src="/3rd/swig.js"></script>
<script src="/js/weixin_lib.js"></script>
<script src="/js/base.js"></script>
<script src="/js/validation.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>

<script>
    var locals = {
        image: {},
    };
    var render = function () {
        $('header').html(swig.render($('#tpl-header').html(), {locals: locals}));
        $('#theme').html(swig.render($('#tpl-theme').html(), {locals: locals}));
        $('#mainbody').html(swig.render($('#tpl-mainbody').html(), {locals: locals}));

    };
    $(function () {
        render();
        api.get('/api/u/wx/config', {url:location.href}, function (data) {
            locals.appId = data.appId;
            locals.timestamp = data.timestamp;
            locals.nonceStr = data.nonceStr;
            locals.signature = data.signature;
            wx.config({
                debug: true,
                appId: locals.appId,
                timestamp: locals.timestamp,
                nonceStr: locals.nonceStr,
                signature: locals.signature,
                jsApiList: [
                    'chooseImage',
                    'uploadImage'
                ]
            });
            wx.ready(function () {
                alert('config success');
            });
            wx.error(function (res) {
                alert(JSON.stringify(res));
            });
        }, dftFail);
    });


    var m_chooseImage = function () {
        wx.chooseImage({
            count: 1,
            sizeType: ['compressed'],
            sourceType: ['album', 'camera'],
            success: function (res) {
                alert('choose success');
                locals.image.localId = res.localIds[0];
                setTimeout(m_uploadImage,100);
            },
            fail: function (res) {
                alert(JSON.stringify(res));
            }
        });
    };
    var m_uploadImage = function () {
        if (locals.image.localId == undefined) {
            alert('未选择图片');
            return;
        } else {
            wx.uploadImage({
                localId: locals.image.localId,
                success: function (res) {
                    locals.image.serverId = res.serverId;
                    alert('上传成功');
                    tmpl = '<li class="weui-uploader__file" onclick = "m_previewImage()" style="background-image: url('+locals.image.localId+')"></li>';
                    $("#uploaderFiles").append($(tmpl));
                    $(".weui-uploader__input-box").hide();
                },
                fail: function (res) {
                    alert(JSON.stringify(res));
                }
            });
        }
    };

    var m_previewImage = function () {
        alert($(".weui-uploader__file").attr("style"));
        $("#galleryImg").attr("style", $(".weui-uploader__file").attr("style"));
        $("#gallery").fadeIn(100);
    }

    var m_backFromPreview = function () {
        $("#gallery").fadeOut(100);
    }

    var m_deleteImage = function () {
        if (locals.image.localId == undefined) {
            alert('未选择图片');
            return;
        } else {
            locals.image.localId = undefined;
            locals.image.serverId = undefined;
            $("#gallery").fadeOut(100);
            $(".weui-uploader__file").remove();
            $(".weui-uploader__input-box").show();
        }
    }
    
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="/css/base.css" rel="stylesheet" type="text/css" />
    <link href="/css/validation.css" rel="stylesheet" type="text/css" />
    <title>绑定学号 - 紫荆之声</title>
</head>
<body>
<div id="wrap">
    <header></header>

    <div class="theme" id="theme"></div>

    <hr/>
    <div id="mainbody"></div>

</div>
<footer id="footer">
    <hr />
    <a href="http://www.xuetangx.com/" target="_blank">学堂在线</a>
    <a href="http://www.tsinghua.edu.cn/" target="_blank">清华大学</a>
    <a href="https://github.com/ThssSE" target="_blank">软件工程</a><br>
    &copy; 2016
</footer>

<script type="text/template" id="tpl-header">
    <img class="header-img" src="/img/logo.jpg" />
</script>

<script type="text/template" id="tpl-theme">
    用户认证
</script>

<script type="text/template" id="tpl-mainbody">
    {% if isLoading %}
    <div id="successHolder">
        <img src="/img/loading.gif" />
    </div>
    {% else %}
    <form id="form-new-found" action="/api/u/found/new" method="post" role="form">

        <input type="text" name="itemName" id="itemName" value="" placeholder="物品名称" required autofocus />
        <span class="spa spa1"></span><br />

        <input type="text" name="itemDescription" id="itemDescription" value="" placeholder="物品描述" />
        <span class="spa spa2"></span><br />

        <input type="text" name="contactNumber" id="contactNumber" value="" placeholder="联系方式" required/>
        <span class="spa spa3"></span><br />

        <input type="text" name="contacts" id="contacts" value="" placeholder="联系人" required/>
        <span class="spa spa4"></span><br />

        <button id="uploadImage">上传图片</button>

        <input id="loginnow" type="submit" class="btn btn-block btn-primary" value="提交">
    </form>
    {% endif %}
</script>

<script src="/3rd/jquery.js"></script>
<script src="/3rd/swig.js"></script>
<script src="/js/weixin_lib.js"></script>
<script src="/js/base.js"></script>
<script src="/js/validation.js"></script>

<script>
    var locals = {};
    var render = function () {
        $('header').html(swig.render($('#tpl-header').html(), {locals: locals}));
        $('#theme').html(swig.render($('#tpl-theme').html(), {locals: locals}));
        $('#mainbody').html(swig.render($('#tpl-mainbody').html(), {locals: locals}));
    };
    $(function () {
        render();
        api.get('/api/u/found/new', {}, function (data) {
            locals.appId = data.appId;
            locals.timestamp = data.timestamp;
            locals.nonceStr = data.nonceStr;
            locals.signature = data.signature;
        }, dftFail);
    });
</script>

<script>
    wx.config({
        debug: true,
        appId: locals.appId,
        timestamp: locals.timestamp,
        nonceStr: locals.nonceStr,
        signature: locals.signature,
        jsApiList: [
            'chooseImage',
        ]
    });
    wx.ready(function () {
        var images = {
            localId: undefined,
            serverId: undefined
        };
        document.querySelector('#chooseImage').onclick = function () {
            wx.chooseImage({
                count: 1,
                sizeType: ['compressed'],
                sourceType: ['album', 'camera'],
                success: function (res) {
                    images.localId = res.localIds[0];
                }
            });
            if (images.localId == undefined) {
                alert('未选择图片');
                return;
            } else {
                wx.uploadImage({
                    localId: images.localId,
                    success: function (res) {
                        images.serverId = res.serverId;
                        alert('上传成功');
                    },
                    fail: function (res) {
                        alert(JSON.stringify(res));
                    }
                });
            }
        }
    });
</script>
</body>
</html>
